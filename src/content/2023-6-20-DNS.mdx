---
date: 2022-11-08
title: Whats DNS
lang: zh-CN
---

## DNS 查询过程

1. 客户端发起查询：当用户在浏览器中输入一个域名（例如www.example.com），客户端的操作系统会发送一个DNS查询请求到本地DNS解析器。

2. 本地DNS解析器查询缓存：本地DNS解析器首先会检查自己的缓存，看是否已经解析过该域名。如果存在缓存记录且没有过期，解析器将直接返回缓存中的IP地址，完成查询。

3. 递归查询：如果本地DNS解析器的缓存中没有相应的记录，它将作为一个客户端，向根域名服务器发送一个递归查询请求。根域名服务器负责管理顶级域名服务器的地址。

4. 根域名服务器返回顶级域名服务器地址：根域名服务器接收到递归查询请求后，会返回给本地DNS解析器一个指向负责该顶级域名的顶级域名服务器的地址。

5. 顶级域名服务器查询：本地DNS解析器接收到顶级域名服务器的地址后，会向该顶级域名服务器发送查询请求。

6. 顶级域名服务器返回权威域名服务器地址：顶级域名服务器接收到查询请求后，会返回给本地DNS解析器一个指向负责该域名的权威域名服务器的地址。

7. 权威域名服务器查询：本地DNS解析器向权威域名服务器发送查询请求。

8. 权威域名服务器返回解析结果：权威域名服务器接收到查询请求后，会查找域名的解析记录，并将解析结果返回给本地DNS解析器。

9. 本地DNS解析器返回解析结果给客户端：本地DNS解析器收到来自权威域名服务器的解析结果后，会将结果保存在缓存中，并将解析结果返回给客户端。

10. 客户端使用解析结果进行访问：客户端收到来自本地DNS解析器的IP地址后，将使用该IP地址进行网络通信，实现对目标服务器的访问。

## DNS 劫持

1. DNS缓存污染：攻击者可以通过篡改本地DNS服务器或其他中间DNS服务器的缓存，将解析结果修改为恶意的IP地址。当用户发起域名解析请求时，DNS服务器会返回被劫持的IP地址，使用户的访问流量被重定向到恶意服务器上。

2. DNS劫持软件：恶意软件可以修改用户计算机上的DNS设置，将本地DNS服务器地址更改为恶意DNS服务器。当用户进行域名解析时，恶意DNS服务器会返回被劫持的IP地址，从而实现DNS劫持攻击。

3. 中间人攻击：攻击者可以在通信链路中插入自己的恶意设备，例如恶意路由器或中间代理服务器。这些设备可以拦截用户的域名解析请求，并返回被劫持的IP地址，使用户的流量被重定向到攻击者控制的服务器上。

4. DNS劫持工具和技术：恶意攻击者可以使用专门的工具和技术，如DNS spoofing（DNS欺骗）或DNS hijacking（DNS劫持）软件，对DNS解析过程进行干扰和篡改，从而实现DNS劫持攻击。

## 对抗 DNS 劫持

使用 DoH(DNS over HTTPS) 或者是 DoT(DNS over TLS)。

以 Windows 为例。 Windows 11已经在系统设置里面引入了DoH，并且从 22H2 开始，Windows 11 上 已经可以在网络设置的可视化界面中配置手动DoH模板了（之前需要我们在命令行设置）。
Windows 11 默认内置了国际主流的 DNS 服务商（包括 CloudFlare 和 GoogleDNS）的 DoH 模板，但是由于众所周知的原因，这些 DNS 在中国大陆的可用性非常低。
我们需要手动配置中国大陆 DNS 服务商的DoH模板。

```PlainText
首选DNS:119.29.29.29
DNS over HTTPS: (开)手动模板
DNS over HTTPS 模板：https://doh.pub/dns-query
```

顾名思义，与使用 UDP 的传统 DNS 不同，DoH 是使用 HTTPS 来查询的。不过事实上，我们依然需要先用传统的 DNS 查询方式来查询 `https://doh.pub/dns-query` 这个网址。

DoH 因为使用 HTTPS，所以其流量通过 443 端口，和其他的 HTTPS 流量混杂在一起，特征不明显。而 DoT 则是使用 853 端口，因此即使请求和响应本身都已加密，但具有网络可见性的任何人都可以发现来回的 DoT 流量

